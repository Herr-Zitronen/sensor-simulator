<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sensor Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
</head>

<body>
    <h1>Datos del Sensor</h1>
    <pre id="output">Esperando datos del sensor...</pre>

    <script>
        
        const broker = window.location.hostname; 
        const port = 9001;
        const clientId = "web_" + Math.random().toString(16).substr(2, 8);
        const topic = "sensor/temperature";

        const client = new Paho.MQTT.Client(broker, port, clientId);

        client.onConnectionLost = function (responseObject) {
            console.log("Conexión perdida:", responseObject.errorMessage);
            document.getElementById("output").textContent = "Conexión perdida: " + responseObject.errorMessage;
        };

        client.onMessageArrived = function (message) {
            console.log("Mensaje recibido:", message.payloadString);
            try {
                const data = JSON.parse(message.payloadString);
                document.getElementById("output").textContent = 
                    `Temperatura: ${data.temperature}°C\nTimestamp: ${data.timestamp}`;
            } catch (e) {
                document.getElementById("output").textContent = message.payloadString;
            }
        };

        client.connect({
            onSuccess: () => {
                console.log("Conectado al broker MQTT");
                client.subscribe(topic);
                document.getElementById("output").textContent = "Conectado al broker MQTT. Esperando datos...";
            },
            onFailure: (err) => {
                console.error("Error de conexión:", err);
                document.getElementById("output").textContent = "Error de conexión: " + JSON.stringify(err);
            },
            useSSL: false
        });
    </script>
</body>

</html>